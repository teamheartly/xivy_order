<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Inward - Xivy</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; background: #f9f9f9; }
    h1 { margin-bottom: 15px; }
    #reader { width: 300px; margin: auto; }
    table { margin: 20px auto; border-collapse: collapse; width: 90%; max-width: 400px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #6c63ff; color: #fff; }
    button { padding: 10px 15px; margin: 10px 5px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    #submitBtn { background: #28a745; color: #fff; }
  </style>
</head>
<body>
  <h1>ðŸ“¥ Stock Inward</h1>
  <div id="reader"></div>

  <table id="skuTable">
    <thead>
      <tr>
        <th>Sr</th>
        <th>SKU</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="submitBtn">Submit & Download CSV</button>

  <script>
    let html5QrCode = new Html5Qrcode("reader");
    let isScanning = false;
    let skuData = {}; // store SKU -> quantity

    async function startScanner() {
      if (isScanning) return;
      try {
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            handleScan(decodedText);
          }
        );
        isScanning = true;
      } catch (err) {
        alert("Camera error: " + err);
      }
    }

    async function stopScanner() {
      if (isScanning) {
        await html5QrCode.stop();
        await html5QrCode.clear();
        isScanning = false;
      }
    }

    function handleScan(sku) {
      if (!sku) return;
      if (skuData[sku]) {
        skuData[sku] += 1;
      } else {
        skuData[sku] = 1;
      }
      updateTable();
      stopScanner().then(() => {
        if (confirm(`SKU: ${sku} scanned.\nDo you want to scan next?`)) {
          startScanner();
        }
      });
    }

    function updateTable() {
      const tbody = document.querySelector("#skuTable tbody");
      tbody.innerHTML = "";
      let sr = 1;
      for (let sku in skuData) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${sr}</td><td>${sku}</td><td>${skuData[sku]}</td>`;
        tbody.appendChild(tr);
        sr++;
      }
    }

    document.getElementById("submitBtn").addEventListener("click", () => {
      if (Object.keys(skuData).length === 0) {
        alert("No SKU scanned!");
        return;
      }
      const timestamp = new Date().toISOString().replace("T"," ").split(".")[0];
      let csvRows = [["Timestamp","SKU","Qty"]];
      for (let sku in skuData) {
        csvRows.push([timestamp, sku, skuData[sku]]);
      }
      const csvContent = "data:text/csv;charset=utf-8," + csvRows.map(e => e.join(",")).join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = `stock_inward_${Date.now()}.csv`;
      link.click();
      alert("âœ… Stock inward saved!");
      skuData = {};
      updateTable();
      startScanner(); // restart scanner for new session
    });

    // start scanner automatically on page load
    window.onload = startScanner;
  </script>
</body>
</html>
